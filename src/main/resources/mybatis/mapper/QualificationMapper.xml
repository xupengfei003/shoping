<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="so.sao.shop.supplier.dao.QualificationDao">

    <!-- 资质审核 - 更新资质状态和时间,拒绝原因 -->
    <update id="updateQualificationStatus">
        UPDATE qualification qua
        SET
        qualification_status = #{qualificationStatus},
        reason = #{ reason },
        update_time = #{updateDate}
        WHERE qua.delete = 0 AND account_id = #{accountId};
    </update>

    <!-- 查询登录供应商的资质状态 -->
    <select id="getAccountQualificationStatus" parameterType="long"  resultType="int">
      SELECT
            qualification_status AS qualificationStatus
      FROM qualification qua
      WHERE  qua.delete = 0 AND qua.account_id = #{ accountId } ;
  </select>

    <select id="findByAccountId" resultType="so.sao.shop.supplier.pojo.output.QualificationOut">
        SELECT
            q.id AS id,
            q.reason AS reason,
            i.qualification_type AS qualificationType,
            i.cloud_name AS cloudName,
            i.min_cloud_name AS minCloudName,
            i.file_name AS fileName,
            i.url AS url,
            i.min_img_url AS minImgUrl,
            q.qualification_status AS qualificationStatus
        FROM
            qualification q
        LEFT JOIN qualification_image i
            ON q.id = i.qualification_id
        WHERE q.delete = 0
            AND i.delete = 0
            AND q.account_id = #{accountId}
    </select>
    <!-- 根据条件查询资质列表 -->
    <select id="findPage" parameterType="so.sao.shop.supplier.pojo.input.QualificationInput" resultType="so.sao.shop.supplier.pojo.output.QualificationListOut">
        SELECT
            q.id AS id,
            a.account_id AS accountId,
            a.provider_name AS providerName,
            a.responsible_phone AS responsiblePhone,
            s.name AS province,
            s1.name AS city,
            s2.name AS district,
            q.create_time AS createTime,
            q.update_time AS updateTime,
            q.qualification_status AS qualificationStatus
        FROM
            qualification q
        LEFT JOIN account a
            ON q.account_id = a.account_id
        LEFT JOIN sys_region s
            ON a.regist_address_province = s.sr_id
        LEFT JOIN sys_region s1
            ON a.regist_address_city = s1.sr_id
        LEFT JOIN sys_region s2
            ON a.regist_address_district = s2.sr_id
        WHERE q.delete = 0
        <if test="@so.sao.shop.supplier.util.Ognl@isNotEmpty(name)">
            AND (
            a.responsible LIKE CONCAT ('%',#{name},'%')
            OR a.provider_name LIKE CONCAT ('%',#{name},'%')
            )
        </if>
        <if test="@so.sao.shop.supplier.util.Ognl@isNotEmpty(status)">
            AND q.qualification_status = #{status}
        </if>
        <if test="@so.sao.shop.supplier.util.Ognl@isNotNull(startCreateTime)">
            AND STR_TO_DATE(DATE_FORMAT(q.create_time,'%Y-%c-%d'),'%Y-%m-%d') <![CDATA[>=]]> STR_TO_DATE(#{startCreateTime},'%Y-%m-%d')
        </if>
        <if test="@so.sao.shop.supplier.util.Ognl@isNotNull(endCreateTime)">
            AND STR_TO_DATE(DATE_FORMAT(q.create_time,'%Y-%c-%d'),'%Y-%m-%d') <![CDATA[<=]]> STR_TO_DATE(#{endCreateTime},'%Y-%m-%d')
        </if>
        <if test="@so.sao.shop.supplier.util.Ognl@isNotNull(startUpdateTime)">
            AND STR_TO_DATE(DATE_FORMAT(q.update_time,'%Y-%c-%d'),'%Y-%m-%d') <![CDATA[>=]]> STR_TO_DATE(#{startUpdateTime},'%Y-%m-%d')
        </if>
        <if test="@so.sao.shop.supplier.util.Ognl@isNotNull(endUpdateTime)">
            AND STR_TO_DATE(DATE_FORMAT(q.update_time,'%Y-%c-%d'),'%Y-%m-%d') <![CDATA[<=]]> STR_TO_DATE(#{endUpdateTime},'%Y-%m-%d')
        </if>
        ORDER BY q.qualification_status,q.create_time
    </select>

   <!--供应商资质入库-->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        INSERT qualification
        (
        account_id,
        qualification_status,
        create_time,
        update_time
        )VALUES (
        #{accountId},
        #{qualificationStatus},
        #{createTime},
        #{updateTime}
        )
    </insert>

    <!--根据供应商ID删除资质表（更新资质表删除状态位）-->
    <update id="delete">
        UPDATE qualification q
        SET
        q.delete= 1
        WHERE
        q.account_id = #{accountId}
    </update>

    <!-- 更新资质状态消息已读状态 -->
    <update id="updateQualificationMessageRead">
        UPDATE account
        SET is_read = 1
        WHERE account_id = #{accountId}
    </update>
    <!-- 判断资质消息是否已读 -->
    <select id="findQualificationStatusIsRead" parameterType="int" resultType="int">
        SELECT is_read
        FROM ACCOUNT
        WHERE account_id = #{accountId}
    </select>

</mapper>